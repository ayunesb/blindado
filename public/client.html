<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blindado • Cliente</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{colors:{brand:"#00E5A8"}}}}</script>
  <script>
    // Read from ?gmaps=... or fall back to embedded key string
    const GMAPS_KEY = new URLSearchParams(location.search).get('gmaps') || 'AlzaSyDlQS_jV0dzGyXhaMZ6HQsV1eFSr4Kvy_s';
    // Optional: if you made a dark styled Map in Google → Map Styles, put the mapId here
    const GMAPS_MAP_ID = 'YOUR_MAP_ID_OR_EMPTY';
    (function loadMaps() {
      const s = document.createElement('script');
      const libs = 'marker'; // add 'places' if you use autocomplete later
      const cb = 'initMap';  // your page already defines initMap
      s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_KEY}&libraries=${libs}&callback=${cb}`;
      s.async = true; s.defer = true;
      document.head.appendChild(s);
    })();
  </script>
</head>
<body class="bg-black text-white min-h-screen">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Blindado</h1>
      <select id="lang" class="bg-zinc-800 rounded px-3 py-2">
        <option value="es">ES</option>
        <option value="en">EN</option>
      </select>
    </header>

    <section class="grid md:grid-cols-2 gap-6">
      <div class="space-y-4">
        <div class="bg-zinc-900/60 p-4 rounded-2xl space-y-3">
          <h2 class="text-lg font-medium" data-i18n="quote_title">Cotización</h2>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm">
              <span data-i18n="city">Ciudad</span>
              <input id="city" class="mt-1 w-full bg-zinc-800 rounded px-3 py-2" value="CDMX">
            </label>
            <label class="text-sm">
              <span data-i18n="tier">Nivel</span>
              <select id="tier" class="mt-1 w-full bg-zinc-800 rounded px-3 py-2">
                <option value="direct">Direct</option>
                <option value="elite">Elite</option>
                <option value="corporate">Corporate</option>
              </select>
            </label>
            <label class="text-sm">
              <input id="armed" type="checkbox" class="mr-2 align-middle"><span data-i18n="armed">Armado</span>
            </label>
            <label class="text-sm">
              <input id="vehicle" type="checkbox" class="mr-2 align-middle"><span data-i18n="vehicle">Vehículo</span>
            </label>
            <label class="text-sm col-span-2">
              <span data-i18n="start">Inicio</span>
              <input id="start" type="datetime-local" class="mt-1 w-full bg-zinc-800 rounded px-3 py-2">
            </label>
            <label class="text-sm col-span-2">
              <span data-i18n="end">Fin</span>
              <input id="end" type="datetime-local" class="mt-1 w-full bg-zinc-800 rounded px-3 py-2">
            </label>
          </div>
          <button id="btnQuote" class="w-full bg-brand hover:opacity-90 text-black font-semibold rounded-xl px-4 py-3">Get Quote</button>
        </div>

        <div class="bg-zinc-900/60 p-4 rounded-2xl space-y-3">
          <h2 class="text-lg font-medium" data-i18n="booking_title">Reservar</h2>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm col-span-2">
              <span>client_id</span>
              <input id="client_id" class="mt-1 w-full bg-zinc-800 rounded px-3 py-2" value="1b387371-6711-485c-81f7-79b2174b90fb">
            </label>
            <label class="text-sm">
              <span>lat</span>
              <input id="lat" class="mt-1 w-full bg-zinc-800 rounded px-3 py-2" value="19.4326">
            </label>
            <label class="text-sm">
              <span>lng</span>
              <input id="lng" class="mt-1 w-full bg-zinc-800 rounded px-3 py-2" value="-99.1332">
            </label>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button id="btnCreate" class="bg-zinc-800 rounded-xl px-4 py-3" data-i18n="create_booking">Crear reserva</button>
            <button id="btnPreauth" class="bg-zinc-800 rounded-xl px-4 py-3" data-i18n="preauth">Preautorizar (simulado)</button>
            <button id="btnConfirm" class="bg-zinc-800 rounded-xl px-4 py-3" data-i18n="confirm">Confirmar</button>
            <button id="btnMatch" class="bg-zinc-800 rounded-xl px-4 py-3" data-i18n="match">Correr matching</button>
          </div>
        </div>
      </div>

      <div class="bg-zinc-900/60 p-4 rounded-2xl">
        <h2 class="text-lg font-medium mb-2" data-i18n="output">Salida</h2>
        <pre id="out" class="text-xs bg-black/50 p-3 rounded-xl h-[560px] overflow-auto"></pre>
      </div>
    </section>
  </div>

      <!-- Map container (used by loader when ?gmaps=KEY is provided) -->
      <div id="map" class="w-full h-[340px] rounded-2xl border border-neutral-800 bg-black/30 hidden"></div>

  <script>
    const DICT = {
      es: {
        quote_title:"Cotización", city:"Ciudad", tier:"Nivel", armed:"Armado", vehicle:"Vehículo",
        start:"Inicio", end:"Fin", booking_title:"Reservar",
        create_booking:"Crear reserva", preauth:"Preautorizar (simulado)", confirm:"Confirmar", match:"Correr matching",
        output:"Salida"
      },
      en: {
        quote_title:"Quote", city:"City", tier:"Tier", armed:"Armed", vehicle:"Vehicle",
        start:"Start", end:"End", booking_title:"Booking",
        create_booking:"Create booking", preauth:"Preauth (stub)", confirm:"Confirm", match:"Run matching",
        output:"Output"
      }
    };
    const FN = "https://isnezquuwepqcjkaupjh.supabase.co/functions/v1";
    const out = (o)=>{document.getElementById('out').textContent = (typeof o==='string'?o:JSON.stringify(o,null,2))+"\n"+document.getElementById('out').textContent}

    function applyLang(lang){
      [...document.querySelectorAll("[data-i18n]")].forEach(el=>{
        const k = el.getAttribute("data-i18n");
        el.textContent = DICT[lang][k] || el.textContent;
      });
      document.getElementById('btnQuote').textContent = (lang==='es'?'Cotizar':'Get Quote');
    }
    const url = new URL(location.href); const lang = url.searchParams.get("lang") || "es";
    document.getElementById("lang").value = lang; applyLang(lang);
    document.getElementById("lang").addEventListener("change",e=>{
      const u = new URL(location.href); u.searchParams.set("lang", e.target.value); location.href = u.toString();
    });

    // helpers
    const headers = {'content-type':'application/json'};
    const val = id => document.getElementById(id).value;

    document.getElementById('btnQuote').onclick = async ()=>{
      const body = {
        city: val('city'), tier: val('tier'),
        armed_required: document.getElementById('armed').checked,
        vehicle_required: document.getElementById('vehicle').checked,
        start_ts: new Date(val('start')||Date.now()).toISOString(),
        end_ts: new Date(val('end')||Date.now()+4*3600e3).toISOString()
      };
      const r = await fetch(`${FN}/pricing`, {method:'POST', headers, body: JSON.stringify(body)});
      out(await r.json());
    };

    let lastBookingId=null, lastPreauth=0;
    document.getElementById('btnCreate').onclick = async ()=>{
      const body = {
        client_id: val('client_id'), city: val('city'), tier: val('tier'),
        armed_required: document.getElementById('armed').checked,
        vehicle_required: document.getElementById('vehicle').checked,
        start_ts: new Date(val('start')||Date.now()).toISOString(),
        end_ts: new Date(val('end')||Date.now()+4*3600e3).toISOString(),
        origin_lat: parseFloat(val('lat')), origin_lng: parseFloat(val('lng'))
      };
      const r = await fetch(`${FN}/bookings`, {method:'POST', headers, body: JSON.stringify(body)});
      const j = await r.json(); out(j); lastBookingId=j.booking_id||j.id; lastPreauth=j.preauth_amount||j.quote_amount||0;
    };
    document.getElementById('btnPreauth').onclick = async ()=>{
      if(!lastBookingId) return out({error:'no booking'});
      const r = await fetch(`${FN}/payments_preauth`, {method:'POST', headers, body: JSON.stringify({booking_id:lastBookingId, amount:lastPreauth})});
      out(await r.json());
    };
    document.getElementById('btnConfirm').onclick = async ()=>{
      if(!lastBookingId) return out({error:'no booking'});
      const r = await fetch(`${FN}/bookings_confirm`, {method:'POST', headers, body: JSON.stringify({booking_id:lastBookingId})});
      out(await r.json());
    };
    document.getElementById('btnMatch').onclick = async ()=>{
      if(!lastBookingId) return out({error:'no booking'});
      const r = await fetch(`${FN}/matching`, {method:'POST', headers, body: JSON.stringify({booking_id:lastBookingId})});
      out(await r.json());
    };
  </script>
  <script>
    // --- Google Maps loader that reads ?gmaps=KEY and mounts a dark map ---
    (function(){
      const params=new URLSearchParams(location.search);
      const GMAPS_KEY=params.get('gmaps');
      if(!GMAPS_KEY){ console.warn('GMAPS key missing. Append ?gmaps=YOUR_KEY to the URL.'); return; }
      const mapEl=document.getElementById('map'); if(!mapEl){ return; }
      mapEl.classList.remove('hidden');
      window.initMap=function(){
        const center={lat:19.4326,lng:-99.1332};
        const map=new google.maps.Map(mapEl,{center,zoom:12,disableDefaultUI:true,styles:[
          {elementType:"geometry",stylers:[{color:"#0b0b0c"}]},
          {elementType:"labels.text.stroke",stylers:[{color:"#0b0b0c"}]},
          {elementType:"labels.text.fill",stylers:[{color:"#9aa0a6"}]},
          {featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#9aa0a6"}]},
          {featureType:"road",elementType:"geometry",stylers:[{color:"#1f1f1f"}]},
          {featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#9aa0a6"}]},
          {featureType:"water",elementType:"geometry",stylers:[{color:"#111315"}]}]});
        const lat=parseFloat(document.getElementById('lat')?.value||'19.4326');
        const lng=parseFloat(document.getElementById('lng')?.value||'-99.1332');
        new google.maps.Marker({position:{lat,lng},map});
      };
      const s=document.createElement('script');
      s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_KEY)}&libraries=marker&callback=initMap`;
      s.async=s.defer=true; document.head.appendChild(s);
    })();
  </script>
</body>
</html>
