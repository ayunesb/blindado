<!doctype html>
<html lang="en" class="h-full bg-black">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blindado — Book Security</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { brand: { 500: "#00E0A4" }}}}};
  </script>
  <style>
    .glass{backdrop-filter: blur(10px); background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08)}
    .btn{ @apply px-4 py-2 rounded-xl border border-white/10 hover:bg-white/10 disabled:opacity-40}
    .pill{ @apply px-3 py-1 rounded-full border border-white/10}
  </style>
</head>
<body class="h-full text-white selection:bg-brand-500/30">
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-brand-500"></div>
        <h1 class="text-2xl font-semibold">Blindado</h1>
      </div>
      <div class="flex items-center gap-2">
        <select id="lang" class="pill bg-black/30">
          <option value="es">Español</option>
          <option value="en" selected>English</option>
        </select>
        <span class="text-xs opacity-60">MVP</span>
      </div>
    </header>

    <!-- Hero -->
    <section class="grid md:grid-cols-2 gap-6">
      <div class="glass rounded-2xl p-6 space-y-4">
        <h2 class="text-xl font-semibold" data-i18n="book_security">Book Security</h2>
        <p class="text-sm opacity-70" data-i18n="mvp_scope">
          Quote → Pre-auth → Matching → Assignment.
        </p>

        <!-- Booking form -->
        <div class="grid grid-cols-2 gap-3 text-sm">
          <label class="col-span-2">
            <span class="opacity-80" data-i18n="client_id_label">Client ID</span>
            <input id="client_id" class="w-full mt-1 bg-black/20 glass rounded-lg p-2" value="1b387371-6711-485c-81f7-79b2174b90fb" />
          </label>
          <label>
            <span class="opacity-80" data-i18n="city">City</span>
            <select id="city" class="w-full mt-1 bg-black/20 glass rounded-lg p-2">
              <option>CDMX</option>
            </select>
          </label>
          <label>
            <span class="opacity-80" data-i18n="tier">Tier</span>
            <select id="tier" class="w-full mt-1 bg-black/20 glass rounded-lg p-2">
              <option value="direct">direct</option>
              <option value="elite">elite</option>
              <option value="corporate">corporate</option>
            </select>
          </label>

          <label>
            <span class="opacity-80" data-i18n="start_iso">Start (ISO)</span>
            <input id="start_ts" type="datetime-local" class="w-full mt-1 bg-black/20 glass rounded-lg p-2" />
          </label>
          <label>
            <span class="opacity-80" data-i18n="end_iso">End (ISO)</span>
            <input id="end_ts" type="datetime-local" class="w-full mt-1 bg-black/20 glass rounded-lg p-2" />
          </label>

          <label>
            <span class="opacity-80">Origin lat</span>
            <input id="origin_lat" class="w-full mt-1 bg-black/20 glass rounded-lg p-2" value="19.4326" />
          </label>
          <label>
            <span class="opacity-80">Origin lng</span>
            <input id="origin_lng" class="w-full mt-1 bg-black/20 glass rounded-lg p-2" value="-99.1332" />
          </label>

          <label class="flex items-center gap-2 mt-2">
            <input id="armed_required" type="checkbox" class="rounded" />
            <span data-i18n="armed">Armed</span>
          </label>
          <label class="flex items-center gap-2 mt-2">
            <input id="vehicle_required" type="checkbox" class="rounded" />
            <span data-i18n="vehicle">Vehicle</span>
          </label>

          <label class="col-span-2">
            <span class="opacity-80" data-i18n="notes">Notes</span>
            <input id="notes" class="w-full mt-1 bg-black/20 glass rounded-lg p-2" placeholder="Business meeting in Polanco" />
          </label>
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap gap-2 pt-2">
          <button id="btnQuote" class="btn" data-i18n="get_quote">Get Quote</button>
          <button id="btnCreate" class="btn" disabled data-i18n="create_booking">Create Booking</button>
          <button id="btnPreauth" class="btn" disabled data-i18n="preauth">Preauth (stub)</button>
          <button id="btnConfirm" class="btn" disabled data-i18n="confirm">Confirm</button>
          <button id="btnMatch" class="btn" disabled data-i18n="run_matching">Run Matching</button>
        </div>
      </div>

      <!-- Map + Output -->
      <div class="space-y-4">
        <div id="map" class="rounded-2xl overflow-hidden glass h-[360px]"></div>
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-medium" data-i18n="output">Output</h3>
            <button class="text-xs opacity-70 hover:opacity-100" onclick="clearOut()">Clear</button>
          </div>
          <pre id="out" class="text-xs whitespace-pre-wrap"></pre>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="text-center text-xs opacity-60">© Blindado MVP</footer>
  </div>

  <script>
    // ---------- CONFIG ----------
    const PROJECT_REF = location.search.match(/ref=([a-z0-9]+)/)?.[1] || "isnezquuwepqcjkaupjh";
    const FN = `https://${PROJECT_REF}.supabase.co/functions/v1`;

    // ---------- I18N ----------
    const dict = {
      en: {
        book_security:"Book Security", mvp_scope:"Quote → Pre-auth → Matching → Assignment.",
        client_id_label:"Client ID", city:"City", tier:"Tier",
        start_iso:"Start (ISO)", end_iso:"End (ISO)", armed:"Armed", vehicle:"Vehicle",
        notes:"Notes", get_quote:"Get Quote", create_booking:"Create Booking",
        preauth:"Preauth (stub)", confirm:"Confirm", run_matching:"Run Matching", output:"Output"
      },
      es: {
        book_security:"Reservar Seguridad", mvp_scope:"Cotiza → Pre-autorización → Búsqueda → Asignación.",
        client_id_label:"ID del Cliente", city:"Ciudad", tier:"Nivel",
        start_iso:"Inicio (ISO)", end_iso:"Fin (ISO)", armed:"Armado", vehicle:"Vehículo",
        notes:"Notas", get_quote:"Obtener Cotización", create_booking:"Crear Reserva",
        preauth:"Pre-autorización (simulada)", confirm:"Confirmar", run_matching:"Correr Matching", output:"Resultado"
      }
    };
    const langSel = document.getElementById('lang');
    function applyI18n(){
      const d = dict[langSel.value]; document.querySelectorAll("[data-i18n]").forEach(n=>n.textContent=d[n.dataset.i18n]);
    }
    langSel.addEventListener('change', applyI18n); applyI18n();

    // ---------- MAP ----------
    const darkStyle=[{"elementType":"geometry","stylers":[{"color":"#0b0b0b"}]},{"elementType":"labels.text.fill","stylers":[{"color":"#e0e0e0"}]},{"elementType":"labels.text.stroke","stylers":[{"color":"#0b0b0b"}]},{"featureType":"poi","stylers":[{"visibility":"off"}]},{"featureType":"road","stylers":[{"color":"#1a1a1a"}]},{"featureType":"water","stylers":[{"color":"#0f2b3c"}]}];
    let map, originMarker;
    function initMap(){
      map = new google.maps.Map(document.getElementById("map"), {
        center: {lat: 19.4326, lng: -99.1332}, zoom: 12, styles: darkStyle
      });
      originMarker = new google.maps.Marker({position:{lat:19.4326, lng:-99.1332}, map, title:"Origin"});
    }
    window.initMap = initMap;

    // ---------- HELPERS ----------
    const out = (x) => {
      const v = typeof x==="string" ? x : JSON.stringify(x,null,2);
      document.getElementById('out').textContent = v + "\n";
    };
    const clearOut = () => document.getElementById('out').textContent="";
    const iso = (d)=> new Date(d).toISOString();

    // Default start/end
    const now = new Date(); const end = new Date(now.getTime()+ 4*3600*1000);
    document.getElementById('start_ts').value = new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16);
    document.getElementById('end_ts').value   = new Date(end.getTime()-end.getTimezoneOffset()*60000).toISOString().slice(0,16);

    let lastQuote, lastBookingId, preauthAmount;

    async function go(path, body, method="POST"){
      if(method==="GET"){
        const r = await fetch(`${FN}${path}`, { method, headers: { "Content-Type":"application/json" }});
        if(!r.ok) throw await r.text(); return r.json();
      }
      const r = await fetch(`${FN}${path}`, { method, headers: { "Content-Type":"application/json" }, body: JSON.stringify(body) });
      if(!r.ok) throw await r.text(); return r.json();
    }

    function formPayload(){
      const p = {
        client_id: document.getElementById('client_id').value.trim(),
        city: document.getElementById('city').value,
        tier: document.getElementById('tier').value,
        armed_required: document.getElementById('armed_required').checked,
        vehicle_required: document.getElementById('vehicle_required').checked,
        start_ts: iso(document.getElementById('start_ts').value),
        end_ts:   iso(document.getElementById('end_ts').value),
        origin: { lat: parseFloat(document.getElementById('origin_lat').value), lng: parseFloat(document.getElementById('origin_lng').value) },
        notes: document.getElementById('notes').value
      };
      originMarker.setPosition(p.origin); map.panTo(p.origin);
      return p;
    }

    // Quote
    document.getElementById('btnQuote').onclick = async ()=>{
      try{
        const res = await go("/pricing", formPayload());
        lastQuote = res; preauthAmount = res.preauth_amount;
        out(res);
        document.getElementById('btnCreate').disabled = false;
      }catch(e){ out(e); }
    };

    // Create
    document.getElementById('btnCreate').onclick = async ()=>{
      try{
        const res = await go("/bookings", {...formPayload(), quote: lastQuote});
        lastBookingId = res.booking_id;
        out(res);
        document.getElementById('btnPreauth').disabled = false;
      }catch(e){ out(e); }
    };

    // Preauth (stub)
    document.getElementById('btnPreauth').onclick = async ()=>{
      try{
        const res = await go("/payments_preauth", { booking_id: lastBookingId, amount: preauthAmount });
        out(res);
        document.getElementById('btnConfirm').disabled = false;
      }catch(e){ out(e); }
    };

    // Confirm → matching
    document.getElementById('btnConfirm').onclick = async ()=>{
      try{
        const res = await go("/bookings_confirm", { booking_id: lastBookingId });
        out(res);
        document.getElementById('btnMatch').disabled = false;
      }catch(e){ out(e); }
    };

    // Matching
    document.getElementById('btnMatch').onclick = async ()=>{
      try{
        const res = await go("/matching", { booking_id: lastBookingId });
        out(res);
      }catch(e){ out(e); }
    };
  </script>

  <!-- Google Maps (insert your browser key; Maps isn’t required for ATs) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY&callback=initMap"></script>
</body>
</html>
