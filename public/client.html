<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Blindado — Book Armed Protectors</title>
  <link rel="preload" as="image" href="/assets/brand/blindado-logo.svg">
  <style>
    :root{
      --bg:#0b0f17;--card:#111827;--muted:#6b7280;--text:#e5e7eb;--accent:#10b981;--danger:#ef4444;--chip:#1f2937;--line:#1f2937;
      --btn:#111827;--btnText:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
    header{display:flex;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(11,15,23,.85);backdrop-filter:saturate(160%) blur(8px)}
    header img{height:32px}
    header .brand{font-weight:800;letter-spacing:.5px}
    main{max-width:760px;margin:16px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
    input,select,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0d1320;color:var(--text)}
    button{cursor:pointer;background:#0f172a}
    .primary{background:var(--accent);color:#062817;border-color:#14b08a;font-weight:700}
    .ghost{background:#0d1320}
    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px}
    .stepper{display:flex;gap:10px;align-items:center;margin:8px 0 16px}
    .dot{width:20px;height:20px;border-radius:50%;display:grid;place-items:center;border:2px solid var(--muted);color:var(--muted);font-size:11px}
    .dot.active{border-color:var(--accent);color:var(--accent)}
    .dot.done{background:var(--accent);border-color:var(--accent);color:#062817}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .line{height:1px;background:var(--line);margin:12px 0}
    .banner{display:none;margin:8px 0;padding:10px;border-radius:12px;background:#1a1f2b;border:1px dashed var(--line);color:#cbd5e1}
    .ok{color:#34d399}
    .warn{color:#f59e0b}
    .err{color:#f87171}
    .hidden{display:none}
    .right{display:flex;justify-content:flex-end;gap:10px}
    .title{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title h1{margin:0;font-size:20px}
    .title small{font-weight:600}
    .price{font-weight:800;font-size:20px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#101623;border-radius:12px;padding:8px 10px}
    .success{border:1px solid rgba(16,185,129,.3);background:rgba(16,185,129,.08)}
    .ghostlink{background:none;border:none;color:#93c5fd;padding:0;cursor:pointer;text-decoration:underline}
  </style>
</head>
<body>
<header>
  <img src="/assets/brand/blindado-logo.svg" alt="Blindado logo"/>
  <div class="brand">BLINDADO</div>
  <div style="margin-left:auto" class="chip" id="cityChip">
    <img src="/assets/brand/ic-shield.svg" width="16" height="16" alt="">
    <span id="cityHero">Detecting city…</span>
  </div>
  <button id="btnWallet" class="btn btn-ghost gap-2" style="margin-left:10px">
    <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24"><path d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v3h-6a3 3 0 1 0 0 6h6v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7zM21 12h-6a1 1 0 1 0 0 2h6v-2z"/></svg>
    <span id="walletLabel" aria-live="polite">Connect Wallet</span>
  </button>
</header>

<main>
  <!-- banner if geolocation denied -->
  <div id="locBanner" class="banner">
    We couldn’t access your location. <button id="btnEnterAddress" class="ghostlink">Enter address instead</button> or <button id="btnRetryGeo" class="ghostlink">retry</button>.
  </div>

  <!-- Stepper -->
  <div class="stepper">
    <div id="s1" class="dot active">1</div><span class="muted">Details</span>
    <div id="s2" class="dot">2</div><span class="muted">Quote</span>
    <div id="s3" class="dot">3</div><span class="muted">Payment</span>
    <div id="s4" class="dot">4</div><span class="muted">Confirm</span>
  </div>

  <!-- Card -->
  <div class="card">
    <div class="title">
      <h1>Book Armed Protectors</h1>
      <span class="pill"><small id="locStatus">Using your device location</small></span>
    </div>

    <!-- FORM: Step 1 -->
    <div id="step1">
      <div class="grid2">
        <div class="col">
          <label>City</label>
          <select id="city">
            <option value="CDMX">CDMX</option>
            <option value="NYC">New York</option>
            <option value="LA">Los Angeles</option>
          </select>
        </div>
        <div class="col">
          <label>Tier</label>
          <select id="tier">
            <option value="direct">Direct</option>
            <option value="premium">Premium</option>
          </select>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="col">
          <label>Start (UTC)</label>
          <input id="start" type="datetime-local"/>
        </div>
        <div class="col">
          <label>End (UTC)</label>
          <input id="end" type="datetime-local"/>
        </div>
      </div>

      <div class="grid2" style="margin-top:8px">
        <div class="col">
          <label>Guard</label>
          <select id="armed">
            <option value="false">Unarmed</option>
            <option value="true">Armed</option>
          </select>
        </div>
        <div class="col">
          <label>Vehicle</label>
          <select id="vehicle">
            <option value="none">None</option>
            <option value="suv">SUV</option>
            <option value="armored">Armored</option>
          </select>
        </div>
      </div>

      <div class="right" style="margin-top:12px">
        <button id="btnQuote" class="primary">Get Quote</button>
      </div>
    </div>

    <!-- QUOTE: Step 2 -->
    <div id="step2" class="hidden">
      <div class="line"></div>
      <div>
        <div class="row" style="align-items:center;justify-content:space-between">
          <div>
            <div class="muted">Estimated total</div>
            <div class="price" id="quote">—</div>
          </div>
          <button id="btnProceed" class="primary">Proceed to Payment</button>
        </div>
      </div>
    </div>

    <!-- PAYMENT (sim or real): Step 3 -->
    <div id="step3" class="hidden">
      <div class="line"></div>
      <div class="grid2">
        <div class="col">
          <label>Name on card</label>
          <input id="cardName" placeholder="Investor Demo"/>
        </div>
        <div class="col">
          <label>Card (demo)</label>
          <input id="cardNum" placeholder="4242 4242 4242 4242"/>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="col"><label>Exp</label><input id="cardExp" placeholder="12/28"/></div>
        <div class="col"><label>CVC</label><input id="cardCvc" placeholder="123"/></div>
      </div>
  <div id="walletInfo" class="muted" style="margin-top:8px"></div>
      <div class="right" style="margin-top:12px">
        <button id="btnPay" class="primary">Pay & Reserve</button>
      </div>
      <div id="payNote" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- CONFIRM + ACCEPTANCE: Step 4 -->
    <div id="step4" class="hidden">
      <div class="line"></div>
      <div class="card success" style="border-radius:12px">
        <div style="display:flex;gap:10px;align-items:center">
          <img src="/assets/brand/ic-shield.svg" width="18" height="18" alt="">
          <div>
            <div style="font-weight:700">Booking confirmed</div>
            <div class="muted" id="confirmMsg">We’re offering this job to nearby protectors…</div>
          </div>
        </div>
      </div>

      <div id="vehicleLine" class="pill" style="margin-top:8px; display:none">
        <img id="vehicleIcon" width="18" height="18" alt=""/>
        <span id="vehicleLabel"></span>
      </div>

      <div class="row" style="margin-top:12px;align-items:center;justify-content:space-between">
        <button id="btnOpenMaps" class="ghost hidden">Open in Maps</button>
        <div class="right">
          <button id="btnSimAccept" class="primary">Simulate Protector Acceptance</button>
        </div>
      </div>
    </div>

    <!-- DEV OUTPUT -->
    <div class="line"></div>
    <pre id="out" class="muted" style="white-space:pre-wrap"></pre>
  </div>
</main>

<script>
/** ------- EIP-1193 shim (safe) ------- */
(function ensureEVMProvider(){
  const g = window;
  const defaults = {
    request: async (req)=>{
      try {
        if (req && (req.method === 'eth_requestAccounts' || req.method === 'eth_accounts')) return [];
        if (req && req.method === 'eth_chainId') return '0x1';
        return null;
      } catch { return null; }
    },
    enable: async ()=>[],
    isConnected: ()=>false,
    on: ()=>{},
    off: ()=>{},
    isMetaMask: false
  };
  if (!g.ethereum){
    g.ethereum = defaults;
  } else if (g.ethereum && typeof g.ethereum.request === 'function') {
    const orig = g.ethereum.request.bind(g.ethereum);
    g.ethereum.request = async (req)=>{
      try { return await orig(req); } catch (e){
        const m = req && req.method;
        if (m === 'eth_requestAccounts' || m === 'eth_accounts') return [];
        if (m === 'eth_chainId') return '0x1';
        console && console.warn && console.warn('ethereum.request error', e);
        return null;
      }
    };
    if (typeof g.ethereum.enable !== 'function') g.ethereum.enable = async ()=>[];
    if (typeof g.ethereum.isConnected !== 'function') g.ethereum.isConnected = ()=>true;
    if (typeof g.ethereum.on !== 'function') g.ethereum.on = ()=>{};
    if (typeof g.ethereum.off !== 'function') g.ethereum.off = ()=>{};
  }
})();
/** ------- helpers ------- */
const q = new URL(location).searchParams;
const SUPABASE_URL = q.get("url") || "https://isnezquuwepqcjkaupjh.supabase.co";
const ANON = q.get("anon") || ""; // pass ?anon=... for real calls
const FN = `${SUPABASE_URL}/functions/v1`;

const out = (...a)=>{ const el=document.getElementById("out"); el.textContent += a.join(" ") + "\n"; }

function headers() {
  const h = { "content-type":"application/json" };
  if (ANON) { h["apikey"] = ANON; h["Authorization"] = `Bearer ${ANON}`; }
  return h;
}

async function post(path, body) {
  try {
    const res = await fetch(`${FN}/${path}`, { method:"POST", headers:headers(), body:JSON.stringify(body) });
    const txt = await res.text();
    let data;
    try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
    if (!res.ok) throw Object.assign(new Error(`HTTP ${res.status}`), { data });
    return data;
  } catch (e) {
    out("[warn] POST /"+path+" failed:", e.message, JSON.stringify(e.data||{},null,2));
    return { _demo:true, ok:true, fallback:true, path, body };
  }
}
/** ------- state ------- */
let center=null, cityDetected="CDMX", cityManual=null, lastQuote=null, bookingId=null;

/** geo + city */
function isoNowPlus(hours=1){ const d=new Date(Date.now()+hours*3600e3);
  d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,16); }

function platformIsIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent); }

function openMapsLink(lat,lng){
  const url = platformIsIOS()
    ? `http://maps.apple.com/?ll=${lat},${lng}`
    : `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
  window.open(url, "_blank");
}

function activate(step){
  ["s1","s2","s3","s4"].forEach((id,i)=>{
    const el=document.getElementById(id);
    el.classList.toggle("active", i===step-1);
    el.classList.toggle("done", i<step-1);
  });
  ["step1","step2","step3","step4"].forEach((id,i)=>{
    document.getElementById(id).classList.toggle("hidden", i!==step-1);
  });
  if (step === 3) {
    const info = document.getElementById('walletInfo');
    if (info) {
      const ws = window['walletState'];
      if (ws && ws.connected && ws.address) {
        const a = ws.address;
        const short = a.slice(0,6) + '…' + a.slice(-4);
        info.textContent = `Wallet connected: ${short}. On-chain payments are disabled in this demo.`;
      } else {
        info.textContent = 'Optional: Connect your wallet (header) — demo uses card preauth.';
      }
    }
  }
}

async function geolocate() {
  return new Promise((resolve)=>{
    if (!navigator.geolocation) { resolve(null); return; }
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const { latitude, longitude } = pos.coords;
        center = { lat: latitude, lng: longitude };
        // naive city detection by lat band (ok for demo)
        cityDetected = Math.abs(latitude-19.4326)<2 ? "CDMX" :
                       Math.abs(latitude-40.7128)<2 ? "NYC"  :
                       Math.abs(latitude-34.0522)<2 ? "LA"   : "CDMX";
        resolve(center);
      },
      ()=> resolve(null),
      { enableHighAccuracy:true, timeout:6000 }
    );
  });
}

/** ------- init UI ------- */
document.getElementById("start").value = isoNowPlus(1);
document.getElementById("end").value   = isoNowPlus(5);
document.getElementById("btnRetryGeo").onclick = ()=> initGeo(true);
document.getElementById("btnEnterAddress").onclick = ()=>{
  cityManual = prompt("Enter city: CDMX, NYC, LA", cityDetected) || cityDetected;
  document.getElementById("city").value = cityManual;
  document.getElementById("cityHero").textContent = cityManual;
};
document.getElementById("btnOpenMaps").onclick = ()=> center && openMapsLink(center.lat, center.lng);

/** wallet connect (optional, never blocks flow) */
const walletBtn = document.getElementById('btnWallet');
const walletLabel = document.getElementById('walletLabel');
;(function initWallet(){
  window['walletState'] = { connected:false, address:null, chainId:null };
})();

async function connectWallet() {
  try {
    if (!window.ethereum || !window.ethereum.request) {
      walletLabel.textContent = 'Wallet not detected';
      walletBtn.classList.add('opacity-70','pointer-events-none');
      return;
    }
    walletLabel.textContent = 'Connecting…';
  const accounts = await window.ethereum.request({ method:'eth_requestAccounts' }).catch(() => []);
    const chainId = await window.ethereum.request({ method:'eth_chainId' }).catch(()=> '0x1');
    if (accounts && accounts.length) {
  window['walletState'] = { connected:true, address:accounts[0], chainId: chainId };
      const short = accounts[0].slice(0,6) + '…' + accounts[0].slice(-4);
      walletLabel.textContent = short;
      localStorage.setItem('wallet.address', accounts[0]);
  localStorage.setItem('wallet.chainId', chainId);
      walletBtn.classList.remove('btn-ghost'); walletBtn.classList.add('btn-success');
    } else {
      walletLabel.textContent = 'Connect Wallet';
    }
  } catch (e) {
    walletLabel.textContent = 'Connect Wallet';
  }
}

walletBtn?.addEventListener('click', connectWallet);

// Restore wallet on load if present
(function restoreWallet(){
  const a = localStorage.getItem('wallet.address');
  const c = localStorage.getItem('wallet.chainId');
  if (a) {
  window['walletState'] = { connected:true, address:a, chainId: c || '0x1' };
    const short = a.slice(0,6) + '…' + a.slice(-4);
    walletLabel.textContent = short;
    walletBtn.classList.remove('btn-ghost'); walletBtn.classList.add('btn-success');
  }
})();

/** quote */
document.getElementById("btnQuote").onclick = async ()=>{
  const city = cityManual || cityDetected || document.getElementById("city").value;
  const tier = document.getElementById("tier").value;
  const armed_required = document.getElementById("armed").value === "true";
  const vehicleSel = document.getElementById("vehicle").value;
  const vehicle_required = vehicleSel !== "none";
  const vehicle_type = vehicle_required ? (vehicleSel==="suv"?"suv":"armored") : null;
  const start_ts = new Date(document.getElementById("start").value+":00Z").toISOString();
  const end_ts   = new Date(document.getElementById("end").value+":00Z").toISOString();

  const payload = {
    city, tier, armed_required, vehicle_required, vehicle_type,
    start_ts, end_ts,
    origin: center || { lat:19.4326,lng:-99.1332 }
  };
  out("→ pricing", JSON.stringify(payload));
  const data = await post("pricing", payload);
  const qEl = document.getElementById("quote");
  const amount = data.quote_amount || data.amount || 0;
  lastQuote = { amount, currency: data.currency || "MXN" };
  qEl.textContent = amount ? `${amount} ${lastQuote.currency}` : "N/A";
  activate(2);
};

/** proceed to payment */
document.getElementById("btnProceed").onclick = ()=> activate(3);

/** pay (preauth real or demo) */
document.getElementById("btnPay").onclick = async ()=>{
  const payNote = document.getElementById("payNote");
  payNote.textContent = "Processing pre-authorization…";

  // 1) create booking
  const origin_lat = center?.lat ?? 19.4326;
  const origin_lng = center?.lng ?? -99.1332;
  const city = (window.cityManual || window.cityDetected || document.getElementById("city").value);
  const tier = document.getElementById("tier").value;
  const armed_required = document.getElementById("armed").value === "true";
  const vehicleSel = document.getElementById("vehicle").value;
  const vehicle_required = vehicleSel !== "none";
  const vehicle_type = vehicle_required ? (vehicleSel==="suv"?"suv":"armored") : null;
  const start_ts = new Date(document.getElementById("start").value+":00Z").toISOString();
  const end_ts   = new Date(document.getElementById("end").value+":00Z").toISOString();
  const bookingPayload = { city, tier, armed_required, vehicle_required, vehicle_type, start_ts, end_ts, origin_lat, origin_lng };
  const booking = await post("bookings", bookingPayload);
  bookingId = booking.booking_id || booking.id || "demo-booking";
  // 2) try to preauth
  const pre = await post("payments_preauth", { booking_id: bookingId, amount: lastQuote?.amount||0, currency: lastQuote?.currency||"MXN" });

  // 3) confirm booking
  await post("bookings_confirm", { booking_id: bookingId, preauth_id: pre.payment_id || pre.id || "demo-preauth" });

  payNote.textContent = pre.fallback ? "Pre-auth simulated for demo." : "Pre-auth approved.";
  document.getElementById("confirmMsg").textContent = "Confirmed. Offering this job to nearby protectors…";
  if (center) document.getElementById("btnOpenMaps").classList.remove("hidden");
  activate(4);

  // kick matching (non-blocking)
  post("matching", { booking_id: bookingId }).then(()=> out("matching started"));
};

/** simulate acceptance (tries real first, then UI only) */
document.getElementById("btnSimAccept").onclick = async ()=>{
  const res = await post("jobs", { action:"accept", booking_id: bookingId });
  const accepted = !res.fallback || true; // UI proceeds anyway for demo
  if (accepted) {
  document.getElementById("confirmMsg").textContent = "Protector assigned.";
  // show vehicle line with icon when applicable
  const sel = document.getElementById("vehicle").value;
  const line = document.getElementById("vehicleLine");
  const icon = document.getElementById("vehicleIcon");
  const label = document.getElementById("vehicleLabel");
  let text = "Client vehicle / on foot";
  let src = "";
  if (sel === "armored") { text = "Armored"; src = "/assets/brand/ic-car-armored.svg"; }
  else if (sel === "suv") { text = "SUV"; src = "/assets/brand/ic-car-suv.svg"; }
  label.textContent = text;
  if (src) { icon.src = src; icon.style.display = "inline-block"; icon.alt = text; }
  else { icon.style.display = "none"; }
  line.style.display = "inline-flex";
    out("✓ protector accepted");
  }
};

/** meta mask noise silencer (keeps demo resilient) */
(function useMetaMaskSilencer(){
  const g=window;
  const originalOnError=g.onerror;
  g.onerror=function(msg,src,lin,col,err){
    if (String(msg||"").toLowerCase().includes("metamask")) return true;
    return originalOnError ? originalOnError(msg,src,lin,col,err) : false;
  };
})();

/** google maps referer noise silencer */
window.addEventListener("error",(e)=>{
  const msg=(e?.message||"").toLowerCase();
  if (msg.includes("google maps javascript api error")) e.preventDefault();
});

/** init geo + city/hero */
async function initGeo(promptRetry=false){
  const ok = await geolocate();
  const banner = document.getElementById("locBanner");
  if (!ok){ banner.style.display="block"; document.getElementById("locStatus").textContent="Location needed — using default CDMX"; }
  else { banner.style.display="none"; document.getElementById("locStatus").textContent="Using your device location"; }
  const citySel = document.getElementById("city");
  citySel.value = cityDetected;
  document.getElementById("cityHero").textContent = cityDetected;
}
initGeo();

/** ------- self-tests for demo safety ------- */
(function selfTests(){
  // 1) ethereum shim never throws
  Promise.resolve().then(async()=>{
    const a = await window.ethereum.request({method:"eth_accounts"});
    if (!Array.isArray(a)) out("[test] ethereum: ok");
  }).catch(()=> out("[test] ethereum: failed"));

  // 2) no map rendered; banner logic works
  const banner = document.getElementById("locBanner");
  out("[test] loc banner initially:", banner.style.display || "none");

  // 3) payload includes origin on quote click – covered by logs
  // 4) wallet button no-provider click does not throw and sets label
  try {
  const saved = window.ethereum;
  window.ethereum = null;
  const btn = document.getElementById('btnWallet');
    btn?.click();
    const lbl = document.getElementById('walletLabel');
    out('[test] wallet no-provider label:', lbl?.textContent||'');
  window.ethereum = saved;
  } catch {}

  // 5) shim chainId returns 0x1
  window.ethereum.request({ method:'eth_chainId' }).then((cid)=>{
    out('[test] shim chainId:', String(cid));
  }).catch(()=> out('[test] shim chainId failed'));

  // 6) booking flow independent from wallet (uses fallback path if needed)
  post('pricing', {}).then(()=> post('bookings', {})).then(()=> post('bookings_confirm', {})).then(()=>{
    out('[test] booking flow independent of wallet: ok');
  }).catch(()=> out('[test] booking flow independent of wallet: failed'));

  // 7) booking payload contains origin_lat/origin_lng numbers
  try {
    const latOk = typeof (center?.lat ?? 19.4326) === 'number';
    const lngOk = typeof (center?.lng ?? -99.1332) === 'number';
    out('[test] booking payload lat/lng numeric:', String(latOk && lngOk));
  } catch {}
})();
</script>
</body>
</html>
