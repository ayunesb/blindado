<!-- public/company.html -->
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Blindado — Portal de Compañía</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script>
      const FN_BASE = 'https://isnezquuwepqcjkaupjh.supabase.co/functions/v1/org_portal';
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-4">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold" id="title">Portal de Compañía</h1>
        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-600">Idioma</label>
          <select id="lang" class="border rounded px-2 py-1">
            <option value="es">ES</option>
            <option value="en">EN</option>
          </select>
        </div>
      </div>

      <!-- Org / API key -->
      <div class="bg-white rounded-xl p-4 shadow mb-6">
        <label class="block text-sm font-medium mb-1" id="lbl_org_key"
          >Clave de Compañía (API key)</label
        >
        <input
          id="org_key"
          class="w-full border rounded px-3 py-2"
          placeholder="demo_org_key_1 (para pruebas)"
        />
        <p class="text-xs text-slate-500 mt-2" id="hint_org_key">
          Pide esta clave a tu super admin. Para freelancers, déjalo vacío.
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Create/Upsert Guard -->
        <div class="bg-white rounded-xl p-4 shadow">
          <h2 class="text-lg font-semibold mb-3" id="sec_guard">Personal (Guardia)</h2>
          <div class="grid grid-cols-2 gap-3">
            <input id="g_first" class="border rounded px-3 py-2" placeholder="Nombre" />
            <input id="g_last" class="border rounded px-3 py-2" placeholder="Apellido" />
            <input
              id="g_email"
              class="border rounded px-3 py-2 col-span-2"
              placeholder="Email (opcional)"
            />
            <input
              id="g_phone"
              class="border rounded px-3 py-2 col-span-2"
              placeholder="+521234567890 (opcional)"
            />
            <input
              id="g_city"
              class="border rounded px-3 py-2 col-span-2"
              placeholder="Ciudad (e.g., CDMX)"
              value="CDMX"
            />
            <label class="text-sm text-slate-600 col-span-2" id="lbl_skills">Habilidades</label>
            <div class="flex items-center gap-2 col-span-2">
              <label class="inline-flex items-center gap-2">
                <input id="g_armed" type="checkbox" class="h-4 w-4" />
                <span id="lbl_armed">Armado</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input id="g_driver" type="checkbox" class="h-4 w-4" checked />
                <span id="lbl_driver">Conductor</span>
              </label>
            </div>
          </div>
          <button
            id="btn_guard"
            class="mt-3 px-4 py-2 rounded bg-black text-white hover:bg-slate-800"
          ></button>
          <pre id="out_guard" class="mt-3 text-xs bg-slate-100 p-3 rounded overflow-auto"></pre>
        </div>

        <!-- Vehicle -->
        <div class="bg-white rounded-xl p-4 shadow">
          <h2 class="text-lg font-semibold mb-3" id="sec_vehicle">Vehículo</h2>
          <div class="grid grid-cols-2 gap-3">
            <select id="v_owned_by" class="border rounded px-3 py-2">
              <option value="company">Compañía</option>
              <option value="guard">Guardia</option>
            </select>
            <input
              id="v_guard_id"
              class="border rounded px-3 py-2"
              placeholder="guard_id (si owned_by=guard)"
            />
            <select id="v_type" class="border rounded px-3 py-2">
              <option value="sedan">Sedán</option>
              <option value="suv" selected>SUV</option>
              <option value="armored_suv">SUV Blindada</option>
            </select>
            <label class="inline-flex items-center gap-2">
              <input id="v_armored" type="checkbox" class="h-4 w-4" />
              <span id="lbl_armored">Blindado</span>
            </label>
            <input id="v_plates" class="border rounded px-3 py-2 col-span-2" placeholder="Placas" />
          </div>
          <button
            id="btn_vehicle"
            class="mt-3 px-4 py-2 rounded bg-black text-white hover:bg-slate-800"
          ></button>
          <pre id="out_vehicle" class="mt-3 text-xs bg-slate-100 p-3 rounded overflow-auto"></pre>
        </div>

        <!-- License -->
        <div class="bg-white rounded-xl p-4 shadow md:col-span-2">
          <h2 class="text-lg font-semibold mb-3" id="sec_license">
            Licencia (porte de arma / etc.)
          </h2>
          <div class="grid grid-cols-2 gap-3">
            <input
              id="l_guard_id"
              class="border rounded px-3 py-2 col-span-2"
              placeholder="guard_id"
            />
            <input
              id="l_type"
              class="border rounded px-3 py-2"
              placeholder="Tipo (e.g., SEDENA)"
              value="SEDENA"
            />
            <input id="l_number" class="border rounded px-3 py-2" placeholder="Número (opcional)" />
            <input
              id="l_valid_to"
              class="border rounded px-3 py-2"
              placeholder="Válida hasta (YYYY-MM-DD)"
            />
            <input id="l_file" type="file" accept="image/*" class="col-span-2" />
          </div>
          <div class="flex gap-2 mt-3">
            <button
              id="btn_license_create"
              class="px-4 py-2 rounded bg-black text-white hover:bg-slate-800"
            ></button>
            <button
              id="btn_license_upload"
              class="px-4 py-2 rounded bg-black text-white hover:bg-slate-800"
              disabled
            ></button>
          </div>
          <pre id="out_license" class="mt-3 text-xs bg-slate-100 p-3 rounded overflow-auto"></pre>
        </div>
      </div>
    </div>

    <script>
      const t = {
        es: {
          title: 'Portal de Compañía',
          lbl_org_key: 'Clave de Compañía (API key)',
          hint_org_key: 'Pide esta clave a tu super admin. Para freelancers, déjalo vacío.',
          sec_guard: 'Personal (Guardia)',
          lbl_skills: 'Habilidades',
          lbl_armed: 'Armado',
          lbl_driver: 'Conductor',
          btn_guard: 'Crear/Registrar Guardia',
          sec_vehicle: 'Vehículo',
          lbl_armored: 'Blindado',
          btn_vehicle: 'Registrar Vehículo',
          sec_license: 'Licencia (porte de arma / etc.)',
          btn_license_create: 'Crear Registro de Licencia',
          btn_license_upload: 'Subir Foto',
        },
        en: {
          title: 'Company Portal',
          lbl_org_key: 'Company Key (API key)',
          hint_org_key: 'Ask your super admin for this key. Leave empty for freelancers.',
          sec_guard: 'Personnel (Guard)',
          lbl_skills: 'Skills',
          lbl_armed: 'Armed',
          lbl_driver: 'Driver',
          btn_guard: 'Create/Upsert Guard',
          sec_vehicle: 'Vehicle',
          lbl_armored: 'Armored',
          btn_vehicle: 'Upsert Vehicle',
          sec_license: 'License (carry permit / etc.)',
          btn_license_create: 'Create License Record',
          btn_license_upload: 'Upload Photo',
        },
      };
      const $ = (id) => document.getElementById(id);
      function applyLang(lang) {
        $('title').textContent = t[lang].title;
        $('lbl_org_key').textContent = t[lang].lbl_org_key;
        $('hint_org_key').textContent = t[lang].hint_org_key;
        $('sec_guard').textContent = t[lang].sec_guard;
        $('lbl_skills').textContent = t[lang].lbl_skills;
        $('lbl_armed').textContent = t[lang].lbl_armed;
        $('lbl_driver').textContent = t[lang].lbl_driver;
        $('btn_guard').textContent = t[lang].btn_guard;
        $('sec_vehicle').textContent = t[lang].sec_vehicle;
        $('lbl_armored').textContent = t[lang].lbl_armored;
        $('btn_vehicle').textContent = t[lang].btn_vehicle;
        $('sec_license').textContent = t[lang].sec_license;
        $('btn_license_create').textContent = t[lang].btn_license_create;
        $('btn_license_upload').textContent = t[lang].btn_license_upload;
      }
      $('lang').addEventListener('change', (e) => applyLang(e.target.value));
      applyLang('es');

      function out(el, data) {
        el.textContent = JSON.stringify(data, null, 2);
      }

      $('btn_guard').onclick = async () => {
        const body = {
          org_key: $('org_key').value || undefined,
          first_name: $('g_first').value,
          last_name: $('g_last').value,
          email: $('g_email').value || undefined,
          phone_e164: $('g_phone').value || undefined,
          city: $('g_city').value || 'CDMX',
          skills: { armed: $('g_armed').checked, driver: $('g_driver').checked },
        };
        const res = await fetch(FN_BASE.replace(/\/$/, '') + '/guards_upsert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const json = await res.json();
        out($('out_guard'), json);
        if (json.guard_id) $('l_guard_id').value = json.guard_id;
        if (json.guard_id && $('v_owned_by').value === 'guard')
          $('v_guard_id').value = json.guard_id;
      };

      $('btn_vehicle').onclick = async () => {
        const body = {
          org_key: $('org_key').value || undefined,
          owned_by: $('v_owned_by').value,
          guard_id: $('v_guard_id').value || undefined,
          type: $('v_type').value,
          armored: $('v_armored').checked,
          plates: $('v_plates').value || undefined,
        };
        const res = await fetch(FN_BASE.replace(/\/$/, '') + '/vehicles_upsert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const json = await res.json();
        out($('out_vehicle'), json);
      };

      let currentLicenseId = null;
      $('btn_license_create').onclick = async () => {
        const body = {
          org_key: $('org_key').value || undefined,
          guard_id: $('l_guard_id').value,
          type: $('l_type').value,
          number: $('l_number').value || undefined,
          valid_to: $('l_valid_to').value || undefined,
        };
        const res = await fetch(FN_BASE.replace(/\/$/, '') + '/licenses_create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const json = await res.json();
        out($('out_license'), json);
        if (json.license_id) {
          currentLicenseId = json.license_id;
          $('btn_license_upload').disabled = false;
        }
      };

      $('btn_license_upload').onclick = async () => {
        const f = $('l_file').files[0];
        if (!f || !currentLicenseId) return;
        const b64 = await fileToBase64(f);
        const body = {
          org_key: $('org_key').value || undefined,
          license_id: currentLicenseId,
          guard_id: $('l_guard_id').value,
          filename: f.name,
          base64: b64,
          content_type: f.type || 'image/jpeg',
        };
        const res = await fetch(FN_BASE.replace(/\/$/, '') + '/licenses_upload_base64', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const json = await res.json();
        out($('out_license'), json);
      };

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }
    </script>
  </body>
</html>
