<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Guard Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:880px;margin:32px auto;padding:0 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    input,button{padding:10px 12px;font-size:14px;border-radius:10px;border:1px solid #ccc}
    button{cursor:pointer}
    .card{border:1px solid #e5e5e5;border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 1px 4px rgba(0,0,0,.05)}
    .muted{color:#666}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#eee;margin-left:4px}
    .btns button{margin-right:6px;margin-top:6px}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h2>Guard Console</h2>
  <div class="row">
    <input id="guardId" placeholder="guard_id (UUID)" style="flex:1" />
    <button id="load">Load Jobs</button>
  </div>
  <div class="muted">Tip: open as <code>?guard_id=YOUR_GUARD_ID</code></div>

  <div id="list"></div>

  <script>
    const BASE = "https://isnezquuwepqcjkaupjh.supabase.co/functions/v1";
    const $ = s => document.querySelector(s);
    const list = $("#list");
    const gi = $("#guardId");

    const params = new URLSearchParams(location.search);
    if (params.get("guard_id")) gi.value = params.get("guard_id");

    $("#load").onclick = load;

    async function load(){
      const guard = gi.value.trim();
      if(!guard) return alert("Enter guard_id");
      list.innerHTML = "Loading…";
      try{
        const res = await fetch(`${BASE}/jobs/list?guard_id=${encodeURIComponent(guard)}`);
        const data = await res.json();
        if (!res.ok) throw new Error(JSON.stringify(data));
        render(data.jobs || []);
      }catch(e){
        list.innerHTML = `<div class="muted">Error: ${e.message}</div>`;
      }
    }

    function render(jobs){
      if(!jobs.length){ list.innerHTML = "<div class='muted'>No jobs.</div>"; return; }
      list.innerHTML = "";
      for(const j of jobs){
        const b = j.bookings || {};
        const wrap = document.createElement("div");
        wrap.className = "card";
        wrap.innerHTML = `
          <div><strong>Assignment</strong> <code>${j.id}</code> <span class="chip">${j.status}</span></div>
          <div class="muted">Booking: <code>${j.booking_id}</code> • City ${b.city} • Tier ${b.tier} • ${new Date(b.start_ts).toLocaleString()} → ${new Date(b.end_ts).toLocaleString()}</div>
          <div class="btns"></div>
        `;
        const btns = wrap.querySelector(".btns");

        if(j.status === "offered"){
          btns.appendChild(btn("Accept", () => postAccept(j.id)));
        } else {
          ["check_in","on_site","in_progress","check_out"].forEach(st => {
            btns.appendChild(btn(title(st), () => postStatus(j.id, st)));
          });
        }

        list.appendChild(wrap);
      }
    }

    function btn(text, onClick){
      const b = document.createElement("button");
      b.textContent = text;
      b.onclick = async () => {
        b.disabled = true;
        try{ await onClick(); await load(); }
        finally{ b.disabled = false; }
      };
      return b;
    }

    function title(s){
      return s.replace(/_/g," ").replace(/\b\w/g, m => m.toUpperCase());
    }

    async function postAccept(assignment_id){
      const res = await fetch(`${BASE}/jobs/accept`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ assignment_id })
      });
      if(!res.ok) throw new Error(await res.text());
    }

    async function postStatus(assignment_id, status){
      const res = await fetch(`${BASE}/jobs/status`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ assignment_id, status })
      });
      if(!res.ok) throw new Error(await res.text());
    }

    if (gi.value) load();
  </script>
</body>
</html>
